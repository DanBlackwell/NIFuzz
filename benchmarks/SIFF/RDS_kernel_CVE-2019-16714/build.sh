#!/bin/bash

set -e

if [[ "$1" == "fuzz" ]]; then
  pushd ../../../
    cargo build --release
  popd
  
  CFLAGS="-Wl,--wrap=malloc -Wl,--wrap=free -Wl,--wrap=realloc -Werror -Wall"
  
  gcc -O3 -c ../../memory.c -o m.o
  
  EXTRA_FILES="m.o"
  
  CC=$PWD/../../../target/release/libafl_cc
  $CC -O0 -Wall $CFLAGS rds_kernel_CVE-2019-16714_fuzz.i m.o -I../../ -o fuzz
  
  rm -f *.o

elif [[ "$1" == "CBMC" || "$1" == "cbmc" ]]; then
  goto-cc rds_kernel_CVE-2019-16714_cbmc.c -o model_check

else
  echo "Usage: $0 [CBMC|fuzz]"
  exit
fi
