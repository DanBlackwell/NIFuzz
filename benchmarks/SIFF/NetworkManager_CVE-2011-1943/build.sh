#!/bin/bash

set -e

if [[ "$1" == "fuzz" ]]; then
  pushd ../../../
    cargo build --release
  popd
  
  CFLAGS="-Wl,--wrap=malloc -Wl,--wrap=free -Wl,--wrap=realloc -Wall"
  
  gcc -O3 -c ../../memory.c -o m.o
  
  EXTRA_FILES="m.o"
  
  CC=$PWD/../../../target/release/libafl_cc
  # $CC -O0 -Wall $CFLAGS rds_kernel_CVE-2019-16714_fuzz.c m.o -I../../ -o fuzz
  $CC $CFLAGS fuzz_harness.c $EXTRA_FILES repo/libnm-util/nm-param-spec-specialized.c repo/libnm-util/nm-setting.c repo/libnm-util/nm-setting-vpn.c -Irepo/libnm-util -I/usr/include/glib-2.0 -I/usr/lib/aarch64-linux-gnu/glib-2.0/include/ -I/usr/lib/x86_64-linux-gnu/glib-2.0/include/ -Irepo/include -I/usr/include/dbus-1.0/ -lglib-2.0 -ldbus-glib-1 -lgobject-2.0 -I../../ -lm -o fuzz

  rm -f *.o

else
  echo "Usage: $0 fuzz"
  exit
fi

