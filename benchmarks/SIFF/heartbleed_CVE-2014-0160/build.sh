#!/bin/bash

set -e

CFLAGS=""
EXTRA_FILES=""
if ! [[ -z "${VANILLA}" ]]; then
  CFLAGS="-D VANILLA_AFL"
  ENV_VARS="AFL_USE_MSAN=1"

elif ! [[ -z "${CBMC}" ]]; then
  echo "BUILDING WITH CBMC"
  CC=goto-cc
  pushd repo
    CC=$CC ./config && make
  popd
  goto-cc cbmc_harness.c --function cbmc_test -DCERT_PATH="./" repo/libssl.a repo/libcrypto.a -Irepo/include -lm -ldl -o test
  exit 0

else
  CFLAGS="-Wl,--wrap=malloc -Wl,--wrap=free -Wl,--wrap=realloc"

  gcc -O3 -c ../../memory.c -o m.o

  EXTRA_FILES="m.o"
fi

 pushd repo
   CC=$PWD/../../../../target/release/libafl_cc
   CXX=$PWD/../../../../target/release/libafl_cxx
   CFLAGS="$CFLAGS -lm"
   # ./config && make clean && make
   ./config && make
 popd

# env $ENV_VARS 
$CC $CFLAGS -v fuzz_harness.c $EXTRA_FILES -DCERT_PATH="./" repo/libssl.a repo/libcrypto.a -I../../ -Irepo/include -lm -ldl -o fuzz

rm -f *.o
