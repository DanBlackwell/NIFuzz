#!/bin/bash

set -e

if [[ "$1" == "fuzz" ]]; then
  CFLAGS="-Wl,--wrap=malloc -Wl,--wrap=free -Wl,--wrap=realloc"
  
  gcc -O3 -c ../../memory.c -o m.o
  
  EXTRA_FILES="m.o"
  
  pushd repo
    CC=$PWD/../../../../target/release/libafl_cc
    CXX=$PWD/../../../../target/release/libafl_cxx
    CFLAGS="$CFLAGS -lm"
    ./config && make clean && make
  popd
  
  # env $ENV_VARS 
  $CC $CFLAGS -v fuzz_harness.c $EXTRA_FILES -DCERT_PATH="./" repo/libssl.a repo/libcrypto.a -I../../ -Irepo/include -lm -ldl -o fuzz
  
  rm -f *.o

elif [[ "$1" == "CBMC" || "$1" == "cbmc" ]]; then
  CC=goto-cc
  CFLAGS=""
  pushd repo
    CC=$CC ./config && make clean && make
  popd
  goto-cc cbmc_harness.c -D CHECK_LEAKAGE=CHECK_2_BITS_LEAKAGE -D CERT_PATH="./" repo/libssl.a repo/libcrypto.a -Irepo/include -I$CBMC_DEFS_DIR -lm -ldl -o model_check

else
  echo "Usage: $0 [CBMC|fuzz]"
  exit
fi
